<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>城市NO₂浓度详情</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", sans-serif;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem 0;
        }

        .card {
            width: 90%;
            max-width: 1000px;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .header {
            margin-bottom: 2rem;
        }

        .back-btn {
            position: absolute;
            top: 2rem;
            left: 2rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 5px;
            text-decoration: none;
            color: #333;
            transition: background 0.3s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.4);
            padding: 1.5rem;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #555;
        }

        #chartCanvas {
            width: 100%;
            height: 400px;
            margin: 2rem 0;
        }

        .accuracy-section {
            margin-top: 3rem;
            padding: 2rem;
            background: rgba(240, 248, 255, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(100, 150, 200, 0.2);
        }

        .accuracy-section h2 {
            color: #2c5282;
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }

        .accuracy-description {
            color: #4a5568;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
            text-align: center;
        }

        #accuracyChartCanvas {
            width: 100%;
            height: 350px;
            margin: 1.5rem 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .accuracy-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .accuracy-metric {
            background: rgba(255, 255, 255, 0.4);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .metric-label {
            display: block;
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            display: block;
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d3748;
        }

        .recommendations {
            text-align: left;
            background: rgba(225, 225, 225, 0.3);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 2rem;
        }

        .recommendations h3 {
            margin-bottom: 1rem;
        }

        .recommendations ul {
            list-style-position: inside;
        }

        .recommendations li {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
<a href="/" class="back-btn">返回首页</a>

<div class="card">
    <div class="header">
        <h1 id="cityName">城市名称</h1>
        <p id="updateTime">更新时间：2023-01-01 12:00</p>
    </div>

    <div class="stats">
        <div class="stat-card">
            <div class="stat-value" id="currentValue">-</div>
            <div class="stat-label">当前NO₂浓度 (μg/m³)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="avgValue">-</div>
            <div class="stat-label">24小时平均浓度 (μg/m³)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="qualityLevel">-</div>
            <div class="stat-label">空气质量等级</div>
        </div>
    </div>

    <canvas id="chartCanvas"></canvas>

    <!-- 预测准确性对比图表 -->
    <div class="accuracy-section">
        <h2>预测准确性分析</h2>
        <p class="accuracy-description">对比昨天的预测值与实际观测值，评估模型预测准确性</p>
        <canvas id="accuracyChartCanvas"></canvas>
        <div id="accuracyStats" class="accuracy-stats">
            <div class="accuracy-metric">
                <span class="metric-label">平均绝对误差:</span>
                <span id="maeValue" class="metric-value">计算中...</span>
            </div>
            <div class="accuracy-metric">
                <span class="metric-label">预测区间覆盖率:</span>
                <span id="coverageValue" class="metric-value">计算中...</span>
            </div>
            <div class="accuracy-metric">
                <span class="metric-label">数据更新时间:</span>
                <span id="accuracyUpdateTime" class="metric-value">-</span>
            </div>
        </div>
    </div>

    <div class="recommendations">
        <h3>健康建议</h3>
        <ul id="recommendationsList">
            <!-- 动态生成内容 -->
        </ul>
    </div>
</div>

<script>
    let chartInstance = null;
    let accuracyChartInstance = null;
    // 获取当前小时
    function getCurrentHour() {
    const now = new Date();
    return now.getHours(); // 返回当前小时数（如7点半返回7）
}

    // 解析URL参数获取城市名
    function getUrlParameter(name) {
        name = name.replace(/\[/, '\\[').replace(/]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    // 获取空气质量等级和建议
    function getAirQualityInfo(value) {
        if (value < 40) {
            return {
                level: '优',
                color: 'green',
                recommendations: [
                    '空气质量令人满意，基本无空气污染',
                    '各类人群可正常活动'
                ]
            };
        } else if (value < 80) {
            return {
                level: '良',
                color: 'yellow',
                recommendations: [
                    '空气质量可接受，但某些污染物可能对极少数异常敏感人群健康有较弱影响',
                    '极少数异常敏感人群应减少户外活动'
                ]
            };
        } else if (value < 180) {
            return {
                level: '轻度污染',
                color: 'orange',
                recommendations: [
                    '易感人群症状有轻度加剧，健康人群出现刺激症状',
                    '儿童、老年人及心脏病、呼吸系统疾病患者应减少长时间、高强度的户外锻炼'
                ]
            };
        } else if (value < 280) {
            return {
                level: '中度污染',
                color: 'red',
                recommendations: [
                    '进一步加剧易感人群症状，可能对健康人群心脏、呼吸系统有影响',
                    '儿童、老年人及心脏病、呼吸系统疾病患者避免长时间、高强度的户外锻炼，一般人群适量减少户外运动'
                ]
            };
        } else {
            return {
                level: '重度污染',
                color: 'purple',
                recommendations: [
                    '心脏病和肺病患者症状显著加剧，运动耐受力降低，健康人群普遍出现症状',
                    '儿童、老年人和心脏病、肺病患者应停留在室内，停止户外运动，一般人群减少户外运动'
                ]
            };
        }
    }

    // 城市背景图片映射
    function getCityBackgroundImage(city) {
        const cityImages = {
            '广州': 'https://images.unsplash.com/photo-1544594376-0a9a6ae2c997?q=80&w=1803&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
            '深圳': 'https://images.unsplash.com/photo-1609515602438-31b5b4362d52?q=80&w=2069&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
            '珠海': 'https://images.unsplash.com/photo-1666960325075-2dd9a901423c?q=80&w=1932&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
            '佛山': '/static/images/foshan.png',
            '惠州': '/static/images/huizhou.png',
            '东莞': '/static/images/dongguan.png',
            '中山': '/static/images/zhongshan.jpg',
            '江门': '/static/images/jiangmen.jpg',
            '肇庆': '/static/images/zhaoqing.png',
            '香港特别行政区': 'https://plus.unsplash.com/premium_photo-1661887277173-f996f36b8fb2?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
            '澳门特别行政区': 'https://images.unsplash.com/photo-1675102128521-b4ab17e003b0?q=80&w=1090&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'
        };

        const normalizedCityNames = {
            '广州': '广州',
            '广州市': '广州',
            '深圳': '深圳',
            '深圳市': '深圳',
            '珠海': '珠海',
            '珠海市': '珠海',
            '佛山': '佛山',
            '佛山市': '佛山',
            '惠州': '惠州',
            '惠州市': '惠州',
            '东莞': '东莞',
            '东莞市': '东莞',
            '中山': '中山',
            '中山市': '中山',
            '江门': '江门',
            '江门市': '江门',
            '肇庆': '肇庆',
            '肇庆市': '肇庆',
            '香港': '香港特别行政区',
            '香港特别行政区': '香港特别行政区',
            '澳门': '澳门特别行政区',
            '澳门特别行政区': '澳门特别行政区'
        };

        const normalizedCity = normalizedCityNames[city] || city;

        if (cityImages[normalizedCity]) {
            return cityImages[normalizedCity];
        }

        return 'https://images.unsplash.com/photo-1501630834273-4b5604d2ee31?auto=format&w=1920';
    }

    // 从后端API获取数据，利用统一的城市映射
    async function fetchCityData(city) {
        try {
            // 获取统一的城市映射（从后端接口）
            const citiesResponse = await fetch('/api/cities');
            const cities = await citiesResponse.json();

            // 使用后端统一的城市映射查找匹配的城市
            // 支持多种匹配方式：完整名称匹配、部分匹配等
            const cityInfo = cities.find(item => {
                // 精确匹配
                if (item.name === city) return true;

                // 支持带"市"后缀的匹配：如"东莞市" 匹配 "东莞"
                if (city.endsWith('市') && item.name === city.slice(0, -1)) return true;
                if (city.endsWith('特别行政区') && item.name === city.slice(0, -5)) return true;

                // 支持不带后缀的匹配：如"东莞" 匹配 "东莞市" （虽然后端应该是标准格式）
                if (item.name.endsWith('市') && item.name.slice(0, -1) === city) return true;
                return item.name.endsWith('特别行政区') && item.name.slice(0, -5) === city;
            });

            if (!cityInfo) {
                throw new Error(`未找到城市${city}的ID`);
            }

            // 获取城市NO2预测数据
            const response = await fetch(`/api/predict/no2/${cityInfo.id}`);
            if (!response.ok) {
                throw new Error('预测数据获取失败');
            }
            const data = await response.json();

            // 关键修改：根据当前小时获取对应的预测浓度
            // 1. 获取当前小时（如7点半返回7）
             const currentHour = getCurrentHour();
            // 2. 假设data.times是["00:00", "01:00", ..., "23:00"]，索引与小时直接对应
            // 取当前小时对应的预测值（如currentHour=7则取索引7的值）
            let currentValue;
            if (data.values && data.values.length > currentHour) {
                currentValue = data.values[currentHour]; // 按当前小时取对应浓度
                } else {
                    // 容错：如果数据长度不足，取最后一个值
                    currentValue = data.values && data.values.length > 0 ? data.values[data.values.length - 1] : 0;
                    console.warn(`预测数据不足24小时，使用最后一个值: ${currentValue}`);
                }

            // 3. 返回处理后的数据（用新的currentValue替换原data.currentValue）
            return {
            city: city,
            updateTime: data.updateTime,
            currentValue: currentValue, // 现在是按当前小时取的值
            avgValue: data.avgValue,
            times: data.times,
            values: data.values,
            low: data.low,
            high: data.high,
            airQuality: getAirQualityInfo(currentValue) // 基于新的currentValue计算空气质量
            };
       } catch (error) {
        console.error('数据获取失败:', error);
        throw error;
    }
}

    // 获取昨天的历史观测数据和预测数据
    async function fetchAccuracyData(city) {
        try {
            // 获取城市ID映射
            const citiesResponse = await fetch('/api/cities');
            const cities = await citiesResponse.json();
            
            const cityInfo = cities.find(item => {
                if (item.name === city) return true;
                if (city.endsWith('市') && item.name === city.slice(0, -1)) return true;
                if (city.endsWith('特别行政区') && item.name === city.slice(0, -5)) return true;
                if (item.name.endsWith('市') && item.name.slice(0, -1) === city) return true;
                return item.name.endsWith('特别行政区') && item.name.slice(0, -5) === city;
            });

            if (!cityInfo) {
                throw new Error(`未找到城市${city}的ID`);
            }

            // 并行获取昨天的历史观测数据和预测数据
            const [actualResponse, predictedResponse] = await Promise.all([
                fetch(`/api/no2/${cityInfo.id}`),
                fetch(`/api/historical-predictions/${cityInfo.id}`)
            ]);

            if (!actualResponse.ok || !predictedResponse.ok) {
                throw new Error('无法获取完整的对比数据');
            }

            const actualData = await actualResponse.json();
            const predictedData = await predictedResponse.json();

            return {
                actual: actualData,
                predicted: predictedData,
                city: city
            };
            
        } catch (error) {
            console.error('准确性数据获取失败:', error);
            throw error;
        }
    }

    // 计算准确性指标
    function calculateAccuracyMetrics(actualData, predictedData) {
        const actualValues = actualData.data.map(record => record.no2_concentration);
        const predictedValues = predictedData.values;
        const predictedLow = predictedData.low;
        const predictedHigh = predictedData.high;
        
        // 确保数据长度匹配（取最小长度）
        const minLength = Math.min(actualValues.length, predictedValues.length);
        const actualTrimmed = actualValues.slice(0, minLength);
        const predictedTrimmed = predictedValues.slice(0, minLength);
        const lowTrimmed = predictedLow.slice(0, minLength);
        const highTrimmed = predictedHigh.slice(0, minLength);
        
        // 计算平均绝对误差 (MAE)
        const mae = actualTrimmed.reduce((sum, actual, i) => {
            return sum + Math.abs(actual - predictedTrimmed[i]);
        }, 0) / actualTrimmed.length;
        
        // 计算预测区间覆盖率
        let covered = 0;
        actualTrimmed.forEach((actual, i) => {
            if (actual >= lowTrimmed[i] && actual <= highTrimmed[i]) {
                covered++;
            }
        });
        const coverage = (covered / actualTrimmed.length) * 100;
        
        return {
            mae: mae.toFixed(2),
            coverage: coverage.toFixed(1),
            dataPoints: minLength
        };
    }

    // 渲染准确性对比图表
    function renderAccuracyChart(accuracyData) {
        const ctx = document.getElementById('accuracyChartCanvas').getContext('2d');

        if (accuracyChartInstance) {
            accuracyChartInstance.destroy();
        }

        const actualData = accuracyData.actual.data;
        const predictedData = accuracyData.predicted;
        
        // 准备数据（确保时间对齐）
        const times = predictedData.times;
        const actualValues = actualData.map(record => record.no2_concentration);
        const predictedValues = predictedData.values;
        const predictedLow = predictedData.low;
        const predictedHigh = predictedData.high;

        // 计算准确性指标
        const metrics = calculateAccuracyMetrics(accuracyData.actual, predictedData);
        
        // 更新准确性指标显示
        document.getElementById('maeValue').textContent = `${metrics.mae} μg/m³`;
        document.getElementById('coverageValue').textContent = `${metrics.coverage}%`;
        document.getElementById('accuracyUpdateTime').textContent = accuracyData.actual.date;

        accuracyChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: times,
                datasets: [
                    {
                        label: '实际观测值',
                        data: actualValues,
                        borderWidth: 4,
                        borderColor: 'rgba(220, 38, 127, 1)',
                        backgroundColor: 'rgba(220, 38, 127, 0.1)',
                        fill: false,
                        tension: 0.1,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: 'rgba(220, 38, 127, 1)',
                        pointBorderColor: 'white',
                        pointBorderWidth: 2,
                        order: 1
                    },
                    {
                        label: '预测值',
                        data: predictedValues,
                        borderWidth: 3,
                        borderColor: 'rgba(59, 130, 246, 0.8)',
                        backgroundColor: 'transparent',
                        fill: false,
                        borderDash: [8, 4],
                        tension: 0.1,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: 'rgba(59, 130, 246, 0.8)',
                        pointBorderColor: 'white',
                        pointBorderWidth: 1,
                        order: 2
                    },
                    {
                        label: '预测区间下限',
                        data: predictedLow,
                        borderWidth: 2,
                        borderColor: 'rgba(156, 163, 175, 0.6)',
                        backgroundColor: 'rgba(229, 231, 235, 0.3)',
                        fill: '+1',
                        borderDash: [4, 4],
                        tension: 0.2,
                        pointRadius: 0,
                        order: 3
                    },
                    {
                        label: '预测区间上限',
                        data: predictedHigh,
                        borderWidth: 2,
                        borderColor: 'rgba(156, 163, 175, 0.6)',
                        backgroundColor: 'transparent',
                        borderDash: [4, 4],
                        tension: 0.2,
                        pointRadius: 0,
                        order: 4
                    }
                ]
            },
            options: {
                responsive: true,
                devicePixelRatio: 2,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'NO₂浓度 (μg/m³)',
                            font: { size: 14, weight: 'bold' },
                            color: '#374151'
                        },
                        ticks: {
                            font: { size: 12 },
                            color: '#6b7280'
                        },
                        grid: {
                            color: 'rgba(156, 163, 175, 0.3)',
                            lineWidth: 1
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '时间 (昨天)',
                            font: { size: 14, weight: 'bold' },
                            color: '#374151'
                        },
                        ticks: {
                            maxTicksLimit: 12,
                            font: { size: 12 },
                            color: '#6b7280'
                        },
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 12, weight: '500' },
                            color: '#374151',
                            usePointStyle: true,
                            pointStyle: 'line'
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#1f2937',
                        bodyColor: '#4b5563',
                        borderColor: '#d1d5db',
                        borderWidth: 1,
                        padding: 12,
                        bodyFont: { size: 12 },
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y.toFixed(1);
                                return `${label}: ${value} μg/m³`;
                            }
                        }
                    }
                }
            }
        });
    }

    // 渲染图表
    function renderChart(data) {
        const ctx = document.getElementById('chartCanvas').getContext('2d');

        if (chartInstance) {
            // @ts-ignore - Chart.js method loaded from CDN
            chartInstance.destroy();
        }

        // @ts-ignore - Chart.js class loaded from CDN
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.times,
                datasets: [
                    {
                        label: 'NO₂浓度 (μg/m³)',
                        data: data.values,
                        borderWidth: 3,
                        borderColor: 'rgba(33, 150, 243, 1)',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        fill: false,
                        tension: 0.1,
                        pointRadius: 6,
                        pointHoverRadius: 7, // 鼠标悬停时点的半径
                        pointBackgroundColor: 'white',
                        pointBorderColor: 'rgba(33, 150, 243, 1)',
                        pointBorderWidth: 2
                    },
                    {
                        label: '预测区间下限',
                        data: data.low,
                        borderWidth: 2, 
                        borderColor: 'rgba(255, 152, 0, 0.7)',
                        backgroundColor: 'rgba(255, 152, 0, 0.45)',
                        fill: true,
                        borderDash: [5, 5],
                        tension: 0.3,
                        pointRadius: 0,
                        order: 1
                    },
                    {
                        label: '预测区间上限',
                        data: data.high,
                        borderWidth: 4, // 预测区间线条稍细
                        borderColor: 'rgba(255, 152, 0, 0.8)',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        tension: 0.1,
                        pointRadius: 0,
                        order: 2
                    }
                ]
            },
            options: {
                responsive: true,
                devicePixelRatio: 2,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {display: true, 
                            text: 'NO₂浓度（μg/m³）',
                            font: {
                                size: 14,
                                weight: 'bold'
                           },
                           color: '#333' // 标题颜色加深
                        },
                         
                        ticks: {
                            font: {size: 13},
                            weight: 'bold',
                            color: '#222'
                        },
                        // 优化Y轴网格线：更清晰但不刺眼
                        grid: {
                            color: 'rgba(200, 200, 200, 0.6)', // 浅灰色网格线
                            lineWidth: 1 // 网格线粗细
                        }
                    },
                    x: {
                        title: {display: true, text: '时间',
                            // 优化X轴标题：增大字体、加粗
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: '#222'
                        },
                        ticks: {
                            maxTicksLimit: 12,
                            font: {
                                size: 13,
                                weight: '600'
                            },
                            color: '#222',
                            // 可选：旋转文字避免重叠（如果时间标签较长）
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: {display: false},
                        
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {font: {size: 13,weight: '500'}}, // 图例文字放大
                        color: '#222' // 颜色浅灰
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#333',
                        bodyColor: '#666',
                        borderColor: '#ddd',
                        borderWidth: 1,
                        padding: 10,
                        bodyFont: {size: 13}
                    }
                }
            }
        });
    }

    // 页面加载时执行
    window.addEventListener('load', async () => {
        const city = getUrlParameter('city') || '广州';

        // 设置城市背景图片
        document.body.style.backgroundImage = `url('${getCityBackgroundImage(city)}')`;

        // 从后端API调取数据
        try {
            // 调用真实接口获取数据（替换模拟数据）
            const realData = await fetchCityData(city);
            // 更新页面内容（与原逻辑一致）
            document.getElementById('cityName').textContent = `${realData.city} NO₂浓度详情`;
            document.getElementById('updateTime').textContent = `更新时间：${realData.updateTime}`;
            document.getElementById('currentValue').textContent = realData.currentValue;
            document.getElementById('avgValue').textContent = realData.avgValue;
            document.getElementById('qualityLevel').textContent = realData.airQuality.level;
            document.getElementById('qualityLevel').style.color = realData.airQuality.color;

            // 渲染健康建议
            const recommendationsList = document.getElementById('recommendationsList');
            recommendationsList.innerHTML = '';
            realData.airQuality.recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec;
                recommendationsList.appendChild(li);
            });

            // 渲染图表
            renderChart(realData);
            
            // 加载并渲染预测准确性分析
            try {
                const accuracyData = await fetchAccuracyData(city);
                renderAccuracyChart(accuracyData);
            } catch (accuracyError) {
                console.error('准确性分析数据加载失败:', accuracyError);
                // 显示错误信息但不阻止主功能
                document.getElementById('maeValue').textContent = '暂无数据';
                document.getElementById('coverageValue').textContent = '暂无数据';
                document.getElementById('accuracyUpdateTime').textContent = '数据获取失败';
                
                // 隐藏准确性图表区域或显示提示信息
                const accuracyCanvas = document.getElementById('accuracyChartCanvas');
                const ctx = accuracyCanvas.getContext('2d');
                ctx.fillStyle = '#f3f4f6';
                ctx.fillRect(0, 0, accuracyCanvas.width, accuracyCanvas.height);
                ctx.fillStyle = '#6b7280';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('暂无昨天的对比数据', accuracyCanvas.width / 2, accuracyCanvas.height / 2);
                ctx.fillText('(需要历史预测数据和观测数据)', accuracyCanvas.width / 2, accuracyCanvas.height / 2 + 25);
            }
            
        } catch (error) {
            console.error('数据加载失败:', error);
            alert('无法获取城市数据，请稍后重试');
        }
    });
</script>
</body>
</html>