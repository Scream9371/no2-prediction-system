<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åŸå¸‚NOâ‚‚æµ“åº¦è¯¦æƒ…</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", sans-serif;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            padding: 0;
            line-height: 1.6;
            margin: 0;
        }

        .card {
            width: 90%;
            max-width: 1000px;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            margin: 0 auto;
        }

        .header {
            margin-bottom: 2rem;
            text-align: center;
        }

        /* å·¦ä¾§å›ºå®šå¯¼èˆªæ  */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            padding: 2rem 1rem;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .back-btn {
            display: block;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            text-decoration: none;
            color: #333;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        .nav-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            text-align: center;
        }

        .section-nav {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 0;
        }

        .nav-item {
            padding: 0.75rem 0;
            text-decoration: none;
            color: #333;
            font-weight: 500;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            text-align: left;
            position: relative;
            border-bottom: 2px solid transparent;
        }

        .nav-item:hover {
            color: #3498db;
        }

        .nav-item.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #3498db;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            margin-left: 250px;
            padding: 2rem;
            width: calc(100% - 250px);
        }

        /* ç»Ÿä¸€å››ä¸ªéƒ¨åˆ†çš„æ ·å¼ */
        .prediction-section,
        .recommendations-section,
        .trend-section,
        .accuracy-section {
            margin-bottom: 4rem;
            scroll-margin-top: 80px; /* ä¸ºé”šç‚¹æ»šåŠ¨æ·»åŠ åç§» */
        }

        /* æœ€åä¸€ä¸ªéƒ¨åˆ†ä¸éœ€è¦åº•éƒ¨é—´è· */
        .accuracy-section {
            margin-bottom: 2rem;
        }

        .prediction-section h2,
        .recommendations-section h2,
        .trend-section h2,
        .accuracy-section h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #2c3e50;
            text-align: center;
            position: relative;
            padding-bottom: 0.75rem;
        }

        .prediction-section h2::after,
        .recommendations-section h2::after,
        .trend-section h2::after,
        .accuracy-section h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            height: 3px;
            background: #3498db;
            width: var(--underline-width, 100px);
        }

        .prediction-tabs,
        .trend-tabs,
        .accuracy-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        /* æ·»åŠ å¹³æ»‘æ»šåŠ¨ */
        html {
            scroll-behavior: smooth;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: #2c3e50;
            line-height: 1.2;
        }

        #chartCanvas {
            width: 100%;
            height: 400px;
            margin: 2rem 0;
        }

        #trendChartCanvas {
            width: 100%;
            height: 400px;
            margin: 2rem 0;
        }


        .accuracy-description,
        .trend-description {
            color: #4a5568;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
            text-align: center;
        }

        /* è¿‘15å¤©è¶‹åŠ¿æ¿å—æ ·å¼ */
        .trend-placeholder {
            text-align: center;
            padding: 3rem 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            border: 2px dashed rgba(59, 130, 246, 0.3);
        }

        .trend-icon {
            font-size: 3rem;
            color: #3498db;
            margin-bottom: 1rem;
        }

        .trend-placeholder p {
            color: #4a5568;
            margin: 0.5rem 0;
        }

        .placeholder-note {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .trend-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .trend-stat-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px;
        }

        .trend-analysis {
            background: rgba(255, 255, 255, 0.1);
            padding: 2rem;
            border-radius: 12px;
        }

        .trend-analysis h4 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .analysis-list {
            list-style: none;
            padding: 0;
        }

        .analysis-list li {
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: #4a5568;
        }

        .analysis-list li:last-child {
            border-bottom: none;
        }

        #accuracyChartCanvas {
            width: 100%;
            height: 350px;
            margin: 1.5rem 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .accuracy-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .accuracy-metric {
            background: rgba(255, 255, 255, 0.4);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .metric-label {
            display: block;
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            display: block;
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d3748;
        }

        /* é˜²æŠ¤å»ºè®®åŒºåŸŸæ ·å¼ - ä¿®æ”¹éƒ¨åˆ† */
        .recommendations-section {
            margin-top: 3rem;
        }

        .recommendations-title {
            text-align: center;
            margin-bottom: 2rem;
            color: #2c5282;
            font-size: 1.8rem;
            position: relative;
            padding-bottom: 10px;
        }

        .recommendations-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background-color: #3182ce;
            border-radius: 3px;
        }

        /* åˆ†ç±»å¡ç‰‡å®¹å™¨ - æ”¹ä¸ºå¹¶æ’æ˜¾ç¤º */
        .recommendation-tabs {
            display: flex;
            overflow-x: auto;
            gap: 0.75rem;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            scrollbar-width: thin;
        }

        .recommendation-tabs::-webkit-scrollbar {
            height: 6px;
        }

        .recommendation-tabs::-webkit-scrollbar-thumb {
            background-color: rgba(100, 150, 200, 0.5);
            border-radius: 3px;
        }

        /* å°å¡ç‰‡æ ·å¼ */
        .tab-card {
            flex: 0 0 auto;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            padding: 1rem;
            min-width: 120px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .tab-card.active {
            background: rgba(59, 130, 246, 0.9);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .tab-card:hover:not(.active) {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        .tab-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .tab-title {
            font-size: 1rem;
            font-weight: 600;
        }

        /* å†…å®¹åŒºåŸŸæ ·å¼ */
        .content-panels {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .content-panel {
            display: none;
        }

        .content-panel.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .recommendation-items {
            list-style-type: none;
        }

        .recommendation-item {
            padding: 0.8rem 0;
            padding-left: 1.5rem;
            position: relative;
            border-bottom: 1px dashed rgba(100, 150, 200, 0.2);
        }

        .recommendation-item:last-child {
            border-bottom: none;
        }

        .recommendation-item::before {
            content: 'â€¢';
            position: absolute;
            left: 0;
            color: #3182ce;
            font-size: 1.5rem;
            line-height: 1;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 767px) {
            .stats {
                grid-template-columns: 1fr;
            }

            .back-btn {
                position: static;
                display: inline-flex;
                margin-bottom: 1rem;
            }

            .header {
                margin-top: 1rem;
            }

            .tab-card {
                min-width: 100px;
                padding: 0.75rem;
            }

            .tab-title {
                font-size: 0.9rem;
            }

            .section-nav {
                flex-direction: column;
                gap: 0.5rem;
            }

            .nav-item {
                text-align: center;
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }

            .prediction-tabs,
            .trend-tabs,
            .accuracy-tabs {
                justify-content: center;
            }

            .trend-stats {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            /* ç§»åŠ¨ç«¯ä¾§è¾¹æ  */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 1rem;
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 1rem;
            }

            .section-nav {
                flex-direction: row;
                gap: 1.5rem;
                overflow-x: auto;
                padding: 0.5rem 0;
            }

            .nav-item {
                white-space: nowrap;
                font-size: 0.85rem;
                padding: 0.5rem 0;
                text-align: center;
                min-width: auto;
            }
        }

        /* AIå°åŠ©æ‰‹æ ·å¼ */
        .ai-assistant {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .ai-assistant:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
        }

        .ai-assistant i {
            color: white;
            font-size: 24px;
        }

        .ai-chat-window {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 380px;
            height: 500px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 1002;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .ai-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .ai-chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .ai-chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .ai-preset-questions {
            padding: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background: rgba(248, 249, 250, 0.8);
        }

        .preset-question-btn {
            display: block;
            width: 100%;
            margin-bottom: 8px;
            padding: 8px 12px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            color: #667eea;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .preset-question-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }

        .preset-question-btn:last-child {
            margin-bottom: 0;
        }

        .ai-chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
        }

        .ai-chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .ai-chat-messages::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 3px;
        }

        .chat-message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .chat-message.user {
            align-items: flex-end;
        }

        .chat-message.ai {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message-bubble.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message-bubble.ai {
            background: rgba(248, 249, 250, 0.9);
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .ai-chat-input {
            padding: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            background: rgba(248, 249, 250, 0.8);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            outline: none;
            font-size: 14px;
            background: white;
        }

        .chat-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .chat-send-btn:hover {
            transform: scale(1.1);
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            padding: 10px 15px;
            color: #666;
            font-size: 13px;
            font-style: italic;
        }

        .typing-dots {
            display: inline-block;
            width: 20px;
        }

        .typing-dots::after {
            content: '';
            animation: typing 1.5s infinite;
        }

        @keyframes typing {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 480px) {
            .ai-chat-window {
                width: calc(100vw - 40px);
                height: calc(100vh - 120px);
                bottom: 100px;
                right: 20px;
                left: 20px;
            }

            .ai-assistant {
                bottom: 20px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
<!-- å·¦ä¾§å›ºå®šå¯¼èˆªæ  -->
<div class="sidebar">
    <a href="/" class="back-btn">
        <i class="fa-solid fa-arrow-left"></i> è¿”å›é¦–é¡µ
    </a>

    <div class="nav-title">é¡µé¢å¯¼èˆª</div>
    <div class="section-nav">
        <a href="#prediction-section" class="nav-item">ä»Šæ—¥é¢„æµ‹ç»“æœ</a>
        <a href="#recommendations-section" class="nav-item">é˜²æŠ¤å»ºè®®</a>
        <a href="#trend-section" class="nav-item">è¿‘15å¤©æµ“åº¦è¶‹åŠ¿</a>
        <a href="#accuracy-section" class="nav-item">æ˜¨æ—¥é¢„æµ‹å‡†ç¡®æ€§åˆ†æ</a>
    </div>
</div>

<!-- ä¸»å†…å®¹åŒºåŸŸ -->
<div class="main-content">
<div class="card">
    <div class="header">
        <h1 id="cityName">åŸå¸‚åç§°</h1>
        <p id="updateTime">æ›´æ–°æ—¶é—´ï¼š2023-01-01 12:00</p>
    </div>

    <!-- ä»Šæ—¥é¢„æµ‹ç»“æœéƒ¨åˆ† -->
    <div id="prediction-section" class="prediction-section">
        <h2>ä»Šæ—¥é¢„æµ‹ç»“æœ</h2>

        <!-- å°å¡ç‰‡å¯¼èˆª -->
        <div class="prediction-tabs">
            <div class="tab-card active" data-tab="data">
                <i class="fa-solid fa-chart-line tab-icon"></i>
                <div class="tab-title">æ•°æ®æ¦‚è§ˆ</div>
            </div>
            <div class="tab-card" data-tab="chart">
                <i class="fa-solid fa-chart-area tab-icon"></i>
                <div class="tab-title">è¶‹åŠ¿å›¾è¡¨</div>
            </div>
        </div>

        <!-- å†…å®¹é¢æ¿ -->
        <div class="content-panels">
            <div class="content-panel active" id="data-panel">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-label">å½“å‰NOâ‚‚æµ“åº¦ (Î¼g/mÂ³)</div>
                        <div class="stat-value" id="currentValue">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">24å°æ—¶å¹³å‡æµ“åº¦ (Î¼g/mÂ³)</div>
                        <div class="stat-value" id="avgValue">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ç©ºæ°”è´¨é‡ç­‰çº§</div>
                        <div class="stat-value" id="qualityLevel">-</div>
                    </div>
                </div>
            </div>
            <div class="content-panel" id="chart-panel">
                <canvas id="chartCanvas"></canvas>
            </div>
        </div>
    </div>

    <!-- é˜²æŠ¤å»ºè®®éƒ¨åˆ† -->
    <div id="recommendations-section" class="recommendations-section">
        <h2>é˜²æŠ¤å»ºè®®</h2>

        <!-- å°å¡ç‰‡å¯¼èˆª -->
        <div class="recommendation-tabs">
            <div class="tab-card active" data-tab="travel">
                <i class="fa-solid fa-location-arrow tab-icon"></i>
                <div class="tab-title">å‡ºè¡Œå»ºè®®</div>
            </div>
            <div class="tab-card" data-tab="home">
                <i class="fa-solid fa-home tab-icon"></i>
                <div class="tab-title">å±…å®¶å»ºè®®</div>
            </div>
            <div class="tab-card" data-tab="outdoor">
                <i class="fa-solid fa-tree tab-icon"></i>
                <div class="tab-title">æˆ·å¤–å»ºè®®</div>
            </div>
            <div class="tab-card" data-tab="exercise">
                <i class="fa-solid fa-dumbbell tab-icon"></i>
                <div class="tab-title">è¿åŠ¨å»ºè®®</div>
            </div>
            <div class="tab-card" data-tab="special">
                <i class="fa-solid fa-users tab-icon"></i>
                <div class="tab-title">ç‰¹æ®Šäººç¾¤</div>
            </div>
            <div class="tab-card" data-tab="general">
                <i class="fa-solid fa-circle-info tab-icon"></i>
                <div class="tab-title">é€šç”¨å»ºè®®</div>
            </div>
        </div>

        <!-- å†…å®¹é¢æ¿ -->
        <div class="content-panels">
            <div class="content-panel active" id="travel-panel">
                <ul id="travelRecommendations" class="recommendation-items">
                    <!-- åŠ¨æ€ç”Ÿæˆå†…å®¹ -->
                </ul>
            </div>
            <div class="content-panel" id="home-panel">
                <ul id="homeRecommendations" class="recommendation-items">
                    <!-- åŠ¨æ€ç”Ÿæˆå†…å®¹ -->
                </ul>
            </div>
            <div class="content-panel" id="outdoor-panel">
                <ul id="outdoorRecommendations" class="recommendation-items">
                    <!-- åŠ¨æ€ç”Ÿæˆå†…å®¹ -->
                </ul>
            </div>
            <div class="content-panel" id="exercise-panel">
                <ul id="exerciseRecommendations" class="recommendation-items">
                    <!-- åŠ¨æ€ç”Ÿæˆå†…å®¹ -->
                </ul>
            </div>
            <div class="content-panel" id="special-panel">
                <ul id="specialRecommendations" class="recommendation-items">
                    <!-- åŠ¨æ€ç”Ÿæˆå†…å®¹ -->
                </ul>
            </div>
            <div class="content-panel" id="general-panel">
                <ul id="generalRecommendations" class="recommendation-items">
                    <!-- åŠ¨æ€ç”Ÿæˆå†…å®¹ -->
                </ul>
            </div>
        </div>
    </div>

    <!-- è¿‘15å¤©æµ“åº¦è¶‹åŠ¿éƒ¨åˆ† -->
    <div id="trend-section" class="trend-section">
        <h2>è¿‘15å¤©æµ“åº¦è¶‹åŠ¿</h2>

        <!-- å°å¡ç‰‡å¯¼èˆª -->
        <div class="trend-tabs">
            <div class="tab-card active" data-tab="overview">
                <i class="fa-solid fa-chart-line tab-icon"></i>
                <div class="tab-title">è¶‹åŠ¿æ¦‚è§ˆ</div>
            </div>
            <div class="tab-card" data-tab="statistics">
                <i class="fa-solid fa-calculator tab-icon"></i>
                <div class="tab-title">ç»Ÿè®¡æ•°æ®</div>
            </div>
            <div class="tab-card" data-tab="analysis">
                <i class="fa-solid fa-magnifying-glass-chart tab-icon"></i>
                <div class="tab-title">è¶‹åŠ¿åˆ†æ</div>
            </div>
        </div>

        <!-- å†…å®¹é¢æ¿ -->
        <div class="content-panels">
            <div class="content-panel active" id="overview-panel">
                <p class="trend-description">å±•ç¤ºè¿‡å»15å¤©çš„NOâ‚‚æµ“åº¦å˜åŒ–è¶‹åŠ¿ï¼Œå¸®åŠ©äº†è§£ç©ºæ°”è´¨é‡çš„å†å²å˜åŒ–æƒ…å†µ</p>
                <!-- æ›¿æ¢å ä½ç¬¦ä¸ºå®é™…å›¾è¡¨å®¹å™¨ -->
                <canvas id="trendChartCanvas"></canvas>
            </div>

            <div class="content-panel" id="statistics-panel">
                <div class="trend-stats">
                    <div class="trend-stat-card">
                        <div class="stat-label">15å¤©å¹³å‡æµ“åº¦</div>
                        <div class="stat-value">--</div>
                    </div>
                    <div class="trend-stat-card">
                        <div class="stat-label">æœ€é«˜æµ“åº¦</div>
                        <div class="stat-value">--</div>
                    </div>
                    <div class="trend-stat-card">
                        <div class="stat-label">æœ€ä½æµ“åº¦</div>
                        <div class="stat-value">--</div>
                    </div>
                    <div class="trend-stat-card">
                        <div class="stat-label">å˜åŒ–å¹…åº¦</div>
                        <div class="stat-value">--</div>
                    </div>
                </div>
            </div>

            <div class="content-panel" id="analysis-panel">
                <div class="trend-analysis">
                    <h4>è¶‹åŠ¿åˆ†ææŠ¥å‘Š</h4>
                    <ul class="analysis-list">
                        <li>æ•´ä½“è¶‹åŠ¿åˆ†æåŠ è½½ä¸­...</li>
                        <li>æœ€é«˜/æœ€ä½æµ“åº¦åˆ†æåŠ è½½ä¸­...</li>
                        <li>å¹³å‡æµ“åº¦è®¡ç®—ä¸­...</li>
                        <li>æ³¢åŠ¨èŒƒå›´åˆ†æä¸­...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- æ˜¨æ—¥é¢„æµ‹å‡†ç¡®æ€§åˆ†æéƒ¨åˆ† -->
    <div id="accuracy-section" class="accuracy-section">
        <h2>æ˜¨æ—¥é¢„æµ‹å‡†ç¡®æ€§åˆ†æ</h2>

        <!-- å°å¡ç‰‡å¯¼èˆª -->
        <div class="accuracy-tabs">
            <div class="tab-card active" data-tab="metrics">
                <i class="fa-solid fa-chart-simple tab-icon"></i>
                <div class="tab-title">å‡†ç¡®æ€§æŒ‡æ ‡</div>
            </div>
            <div class="tab-card" data-tab="comparison">
                <i class="fa-solid fa-chart-line tab-icon"></i>
                <div class="tab-title">å¯¹æ¯”å›¾è¡¨</div>
            </div>
        </div>

        <!-- å†…å®¹é¢æ¿ -->
        <div class="content-panels">
            <div class="content-panel active" id="metrics-panel">
                <p class="accuracy-description">å¯¹æ¯”æ˜¨å¤©çš„é¢„æµ‹å€¼ä¸å®é™…è§‚æµ‹å€¼ï¼Œè¯„ä¼°æ¨¡å‹é¢„æµ‹å‡†ç¡®æ€§</p>
                <div id="accuracyStats" class="accuracy-stats">
                    <div class="accuracy-metric">
                        <span class="metric-label">å¹³å‡ç»å¯¹è¯¯å·®</span>
                        <span id="maeValue" class="metric-value">è®¡ç®—ä¸­...</span>
                    </div>
                    <div class="accuracy-metric">
                        <span class="metric-label">é¢„æµ‹åŒºé—´è¦†ç›–ç‡</span>
                        <span id="coverageValue" class="metric-value">è®¡ç®—ä¸­...</span>
                    </div>
                    <div class="accuracy-metric">
                        <span class="metric-label">æ•°æ®æ›´æ–°æ—¶é—´</span>
                        <span id="accuracyUpdateTime" class="metric-value">-</span>
                    </div>
                </div>
            </div>
            <div class="content-panel" id="comparison-panel">
                <canvas id="accuracyChartCanvas"></canvas>
            </div>
        </div>
    </div>
</div>
</div>

<!-- AIå°åŠ©æ‰‹ -->
<div class="ai-assistant" id="aiAssistant">
    <i class="fa-solid fa-robot"></i>
</div>

<!-- AIèŠå¤©çª—å£ -->
<div class="ai-chat-window" id="aiChatWindow">
    <!-- èŠå¤©çª—å£å¤´éƒ¨ -->
    <div class="ai-chat-header">
        <h3><i class="fa-solid fa-robot"></i> NOâ‚‚ AIå°åŠ©æ‰‹</h3>
        <button class="ai-chat-close" id="aiChatClose">
            <i class="fa-solid fa-times"></i>
        </button>
    </div>

    <!-- é¢„è®¾é—®é¢˜åŒºåŸŸ -->
    <div class="ai-preset-questions">
        <button class="preset-question-btn" data-question="NOâ‚‚çš„å±å®³æœ‰å“ªäº›ï¼Ÿ">
            NOâ‚‚çš„å±å®³æœ‰å“ªäº›ï¼Ÿ
        </button>
        <button class="preset-question-btn" data-question="å½“å‰åŸå¸‚çš„NOâ‚‚æµ“åº¦æ°´å¹³å¦‚ä½•ï¼Ÿ">
            å½“å‰åŸå¸‚çš„NOâ‚‚æµ“åº¦æ°´å¹³å¦‚ä½•ï¼Ÿ
        </button>
        <button class="preset-question-btn" data-question="è¿‘æœŸNOâ‚‚æµ“åº¦å˜åŒ–è¶‹åŠ¿æ€æ ·ï¼Ÿ">
            è¿‘æœŸNOâ‚‚æµ“åº¦å˜åŒ–è¶‹åŠ¿æ€æ ·ï¼Ÿ
        </button>
        <button class="preset-question-btn" data-question="é«˜NOâ‚‚æµ“åº¦æ—¶åº”è¯¥å¦‚ä½•é˜²æŠ¤ï¼Ÿ">
            é«˜NOâ‚‚æµ“åº¦æ—¶åº”è¯¥å¦‚ä½•é˜²æŠ¤ï¼Ÿ
        </button>
        <button class="preset-question-btn" data-question="NOâ‚‚æµ“åº¦å¯¹è¿åŠ¨æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ">
            NOâ‚‚æµ“åº¦å¯¹è¿åŠ¨æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ
        </button>
    </div>

    <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
    <div class="ai-chat-messages" id="aiChatMessages">
        <div class="chat-message ai">
            <div class="message-bubble ai">
                ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯NOâ‚‚ AIå°åŠ©æ‰‹ï¼Œå¯ä»¥ä¸ºæ‚¨è§£ç­”å…³äºç©ºæ°”è´¨é‡ã€NOâ‚‚æµ“åº¦å’Œå¥åº·é˜²æŠ¤çš„é—®é¢˜ã€‚æ‚¨å¯ä»¥ç‚¹å‡»ä¸Šæ–¹çš„é¢„è®¾é—®é¢˜ï¼Œæˆ–ç›´æ¥è¾“å…¥æ‚¨æƒ³äº†è§£çš„å†…å®¹ï¼
            </div>
            <div class="message-time" id="welcomeTime"></div>
        </div>
    </div>

    <!-- æ‰“å­—æŒ‡ç¤ºå™¨ -->
    <div class="typing-indicator" id="typingIndicator">
        AIå°åŠ©æ‰‹æ­£åœ¨å›å¤<span class="typing-dots"></span>
    </div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="ai-chat-input">
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." maxlength="200">
            <button class="chat-send-btn" id="chatSendBtn">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>
    let chartInstance = null;
    let accuracyChartInstance = null;
    let trendChartInstance = null; // æ·»åŠ è¶‹åŠ¿å›¾è¡¨å®ä¾‹

    // è·å–å½“å‰å°æ—¶
    function getCurrentHour() {
        const now = new Date();
        return now.getHours(); // è¿”å›å½“å‰å°æ—¶æ•°ï¼ˆå¦‚7ç‚¹åŠè¿”å›7ï¼‰
    }

    // è§£æURLå‚æ•°è·å–åŸå¸‚å
    function getUrlParameter(name) {
        name = name.replace(/\[/, '\\[').replace(/]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    // è·å–ç©ºæ°”è´¨é‡ç­‰çº§å’Œåˆ†ç±»å»ºè®®
    function getAirQualityInfo(value) {
        // å®šä¹‰æµ“åº¦åˆ†çº§æ ‡å‡†
        const levels = {
            low: value < 40,
            medium: value >= 40 && value < 120,
            high: value >= 120
        };

        // æ ¹æ®æµ“åº¦è¿”å›å¯¹åº”çš„å»ºè®®
        if (levels.low) {
            return {
                level: 'ä¼˜',
                color: 'green',
                recommendations: {
                    travel: [
                        'æ¨èæ­¥è¡Œæˆ–éª‘è¡Œï¼Œæ—¢èƒ½äº«å—æ¸…æ–°ç©ºæ°”ï¼Œåˆèƒ½é”»ç‚¼èº«ä½“',
                        'é©¾è½¦æ—¶å¯å¼€å¯å¤–å¾ªç¯ï¼Œä¿æŒè½¦å†…ç©ºæ°”æµé€š'
                    ],
                    home: [
                        'æ¯å¤©å¼€çª—é€šé£2-3æ¬¡ï¼Œæ¯æ¬¡30åˆ†é’Ÿä»¥ä¸Š',
                        'çƒ¹é¥ªæ—¶å¼€å¯æ²¹çƒŸæœºï¼ŒåŠæ—¶æ’å‡ºå¨æˆ¿åºŸæ°”'
                    ],
                    outdoor: [
                        'å¯ä»¥æ”¾å¿ƒå‰å¾€å…¬å›­ã€éƒŠå¤–ç­‰åœ°è¿›è¡Œæˆ·å¤–æ´»åŠ¨',
                        'æ— éœ€ç‰¹åˆ«é˜²æŠ¤æªæ–½ï¼Œæ­£å¸¸å®‰æ’æˆ·å¤–è¡Œç¨‹'
                    ],
                    exercise: [
                        'é€‚åˆè¿›è¡Œæ™¨è·‘ã€éª‘è¡Œã€çƒç±»è¿åŠ¨ç­‰é«˜æ´»åŠ›é”»ç‚¼',
                        'è¿åŠ¨æ—¶é—´å’Œå¼ºåº¦å¯æŒ‰ä¸ªäººä¹ æƒ¯æ­£å¸¸å®‰æ’'
                    ],
                    special: [
                        'å©´å¹¼å„¿ï¼šå¯ä»¥æ­£å¸¸å¤–å‡ºæ™’å¤ªé˜³ï¼Œä¿ƒè¿›é’™å¸æ”¶',
                        'è€äººå’Œæ…¢æ€§ç—…æ‚£è€…ï¼šå¯åœ¨åº­é™¢ã€é˜³å°ä¼‘æ¯ï¼Œå‘¼å¸æ–°é²œç©ºæ°”'
                    ],
                    general: [
                        'ç©ºæ°”è´¨é‡ä¼˜è‰¯ï¼Œæ— éœ€ç‰¹åˆ«é˜²æŠ¤',
                        'å¯å¤šå…³æ³¨ç©ºæ°”è´¨é‡å˜åŒ–ï¼Œä¿æŒå¥åº·ç”Ÿæ´»ä¹ æƒ¯'
                    ]
                }
            };
        } else if (levels.medium) {
            return {
                level: value < 80 ? 'è‰¯' : 'è½»åº¦æ±¡æŸ“',
                color: value < 80 ? 'yellow' : 'orange',
                recommendations: {
                    travel: [
                        'ä¼˜å…ˆé€‰æ‹©åœ°é“ã€ç§å®¶è½¦ç­‰å°é—­æ€§å¥½çš„äº¤é€šå·¥å…·',
                        'æ­¥è¡Œæˆ–éª‘è¡Œæ—¶å»ºè®®ä½©æˆ´æ™®é€šåŒ»ç”¨å£ç½©',
                        'é¿å¼€äº¤é€šæ‹¥å µè·¯æ®µå’Œé«˜å³°æ—¶æ®µå‡ºè¡Œ'
                    ],
                    home: [
                        'æ¯å¤©å¼€çª—é€šé£1-2æ¬¡ï¼Œæ¯æ¬¡15åˆ†é’Ÿå·¦å³',
                        'é€šé£æ—¶é—´é¿å¼€æ—©æ™šäº¤é€šé«˜å³°æ—¶æ®µ',
                        'æœ‰æ¡ä»¶å¯å¼€å¯ç©ºæ°”å‡€åŒ–å™¨'
                    ],
                    outdoor: [
                        'å‡å°‘ä¸å¿…è¦çš„æˆ·å¤–æ´»åŠ¨æ—¶é—´',
                        'é¿å…é•¿æ—¶é—´åœç•™åœ¨äº¤é€šç¹å¿™åŒºåŸŸ'
                    ],
                    exercise: [
                        'é€‰æ‹©è½»åº¦è¿åŠ¨ï¼Œè¿åŠ¨æ—¶é—´æ§åˆ¶åœ¨1å°æ—¶ä»¥å†…',
                        'å°½é‡é¿å¼€äº¤é€šé«˜å³°æ—¶æ®µè¿›è¡Œæˆ·å¤–è¿åŠ¨'
                    ],
                    special: [
                        'å©´å¹¼å„¿ï¼šæˆ·å¤–æ´»åŠ¨æ—¶é—´æ§åˆ¶åœ¨30åˆ†é’Ÿä»¥å†…ï¼Œè¿œç¦»æ±¡æŸ“åŒºåŸŸ',
                        'å‘¼å¸é“ç–¾ç—…æ‚£è€…ï¼šéšèº«æºå¸¦æ€¥æ•‘è¯ç‰©ï¼Œä½¿ç”¨åŠ æ¹¿å™¨ä¿æŒå®¤å†…æ¹¿åº¦',
                        'æ•æ„Ÿäººç¾¤ï¼šå‡å°‘æˆ·å¤–æ´»åŠ¨æ—¶é—´ï¼Œå¤–å‡ºæ—¶ä½©æˆ´å£ç½©'
                    ],
                    general: [
                        'å…³æ³¨ç©ºæ°”è´¨é‡å˜åŒ–ï¼Œåšå¥½ä¸ªäººé˜²æŠ¤',
                        'å¤–å‡ºè¿”å›ååŠæ—¶æ´—æ‰‹æ¼±å£'
                    ]
                }
            };
        } else {
            return {
                level: value < 240 ? 'ä¸­åº¦æ±¡æŸ“' : 'é‡åº¦æ±¡æŸ“',
                color: value < 240 ? 'red' : 'purple',
                recommendations: {
                    travel: [
                        'å°½é‡å‡å°‘å¤–å‡ºï¼Œå¿…è¦å¤–å‡ºæ—¶ä½©æˆ´KN95/N95å£ç½©',
                        'ç¼©çŸ­æˆ·å¤–åœç•™æ—¶é—´ï¼Œé¿å…è§¦æ‘¸æˆ·å¤–ç‰©å“',
                        'è´­ç‰©ä¼˜å…ˆé€‰æ‹©çº¿ä¸Šï¼Œçº¿ä¸‹è´­ç‰©æ§åˆ¶åœ¨30åˆ†é’Ÿå†…'
                    ],
                    home: [
                        'å…¨å¤©å…³é—­é—¨çª—ï¼Œå¼€å¯ç©ºæ°”å‡€åŒ–å™¨',
                        'é¿å…çƒ¹é¥ªï¼Œè‹¥å¿…é¡»åšé¥­ï¼Œéœ€ç´§é—­å¨æˆ¿é—¨å¹¶ä½¿ç”¨æ²¹çƒŸæœº',
                        'å›å®¶ååŠæ—¶æ›´æ¢è¡£ç‰©ã€æ¸…æ´—å£é¼»'
                    ],
                    outdoor: [
                        'å°½é‡é¿å…æ‰€æœ‰æˆ·å¤–æ´»åŠ¨',
                        'å¦‚å¿…é¡»å¤–å‡ºï¼Œé€‰æ‹©æ±¡æŸ“ç›¸å¯¹è¾ƒä½çš„æ—¶æ®µï¼Œç¼©çŸ­åœç•™æ—¶é—´'
                    ],
                    exercise: [
                        'å»ºè®®é€‰æ‹©å®¤å†…è½»åº¦è¿åŠ¨ï¼Œå¦‚ç‘œä¼½ã€å®¤å†…å¥èº«ç­‰',
                        'æ•æ„Ÿäººç¾¤åº”æš‚åœæ‰€æœ‰é”»ç‚¼ï¼Œä¿æŒå®‰é™ä¼‘æ¯'
                    ],
                    special: [
                        'å©´å¹¼å„¿ï¼šä¸¥ç¦å¤–å‡ºï¼Œå®¤å†…æ´»åŠ¨æ—¶è¿œç¦»é—¨çª—',
                        'æ…¢æ€§ç—…æ‚£è€…ï¼šå‡å°‘æ´»åŠ¨é‡ï¼Œç›‘æµ‹èº«ä½“æŒ‡æ ‡ï¼Œä¸é€‚æ—¶è”ç³»åŒ»ç”Ÿ',
                        'å‘¼å¸é“ç–¾ç—…æ‚£è€…ï¼šå‡å°‘æ´»åŠ¨ï¼Œå¤‡å¥½æ€¥æ•‘è¯ç‰©ï¼Œå¿…è¦æ—¶åŠæ—¶å°±åŒ»',
                        'å°±åŒ»æ—¶æå‰çº¿ä¸ŠæŒ‚å·ï¼Œå‡å°‘åŒ»é™¢æˆ·å¤–ç­‰å¾…æ—¶é—´ï¼Œå…¨ç¨‹ä½©æˆ´N95å£ç½©'
                    ],
                    general: [
                        'å…³æ³¨ç©ºæ°”è´¨é‡å®æ—¶æ•°æ®ï¼Œäº†è§£æœ€æ–°é˜²æŠ¤ä¿¡æ¯',
                        'ä¿æŒå®¤å†…æ¸…æ´ï¼Œå®šæœŸæ›´æ¢ç©ºæ°”å‡€åŒ–å™¨æ»¤ç½‘',
                        'æ³¨æ„å‘¼å¸é“ç—‡çŠ¶ï¼Œå¦‚å‡ºç°ä¸é€‚åŠæ—¶å°±åŒ»'
                    ]
                }
            };
        }
    }

    // åŸå¸‚èƒŒæ™¯å›¾ç‰‡æ˜ å°„
    function getCityBackgroundImage(city) {
        const cityImages = {
            'å¹¿å·': '/static/images/guangzhou.png',
            'æ·±åœ³': '/static/images/shenzhen.png',
            'ç æµ·': '/static/images/zhuhai.png',
            'ä½›å±±': '/static/images/foshan.png',
            'æƒ å·': '/static/images/huizhou.png',
            'ä¸œè': '/static/images/dongguan.png',
            'ä¸­å±±': '/static/images/zhongshan.png',
            'æ±Ÿé—¨': '/static/images/jiangmen.jpg',
            'è‚‡åº†': '/static/images/zhaoqing.png',
            'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº': '/static/images/hongkong.png',
            'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº': '/static/images/macao.png'
        };

        const normalizedCityNames = {
            'å¹¿å·': 'å¹¿å·',
            'å¹¿å·å¸‚': 'å¹¿å·',
            'æ·±åœ³': 'æ·±åœ³',
            'æ·±åœ³å¸‚': 'æ·±åœ³',
            'ç æµ·': 'ç æµ·',
            'ç æµ·å¸‚': 'ç æµ·',
            'ä½›å±±': 'ä½›å±±',
            'ä½›å±±å¸‚': 'ä½›å±±',
            'æƒ å·': 'æƒ å·',
            'æƒ å·å¸‚': 'æƒ å·',
            'ä¸œè': 'ä¸œè',
            'ä¸œèå¸‚': 'ä¸œè',
            'ä¸­å±±': 'ä¸­å±±',
            'ä¸­å±±å¸‚': 'ä¸­å±±',
            'æ±Ÿé—¨': 'æ±Ÿé—¨',
            'æ±Ÿé—¨å¸‚': 'æ±Ÿé—¨',
            'è‚‡åº†': 'è‚‡åº†',
            'è‚‡åº†å¸‚': 'è‚‡åº†',
            'é¦™æ¸¯': 'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº',
            'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº': 'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº',
            'æ¾³é—¨': 'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº',
            'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº': 'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº'
        };

        const normalizedCity = normalizedCityNames[city] || city;

        if (cityImages[normalizedCity]) {
            return cityImages[normalizedCity];
        }

        return 'https://images.unsplash.com/photo-1501630834273-4b5604d2ee31?auto=format&w=1920';
    }

    // ä»åç«¯APIè·å–æ•°æ®
    async function fetchCityData(city) {
        try {
            // è·å–ç»Ÿä¸€çš„åŸå¸‚æ˜ å°„ï¼ˆä»åç«¯æ¥å£ï¼‰
            const citiesResponse = await fetch('/api/cities');
            const cities = await citiesResponse.json();

            // ä½¿ç”¨åç«¯ç»Ÿä¸€çš„åŸå¸‚æ˜ å°„æŸ¥æ‰¾åŒ¹é…çš„åŸå¸‚
            const cityInfo = cities.find(item => {
                if (item.name === city) return true;
                if (city.endsWith('å¸‚') && item.name === city.slice(0, -1)) return true;
                if (city.endsWith('ç‰¹åˆ«è¡Œæ”¿åŒº') && item.name === city.slice(0, -5)) return true;
                if (item.name.endsWith('å¸‚') && item.name.slice(0, -1) === city) return true;
                return item.name.endsWith('ç‰¹åˆ«è¡Œæ”¿åŒº') && item.name.slice(0, -5) === city;
            });

            if (!cityInfo) {
                throw new Error(`æœªæ‰¾åˆ°åŸå¸‚${city}çš„ID`);
            }

            // è·å–åŸå¸‚NO2é¢„æµ‹æ•°æ®
            const response = await fetch(`/api/predict/no2/${cityInfo.id}`);
            if (!response.ok) {
                throw new Error('é¢„æµ‹æ•°æ®è·å–å¤±è´¥');
            }
            const data = await response.json();

            // æ ¹æ®å½“å‰å°æ—¶è·å–å¯¹åº”çš„é¢„æµ‹æµ“åº¦
            const currentHour = getCurrentHour();
            let currentValue;
            if (data.values && data.values.length > currentHour) {
                currentValue = data.values[currentHour];
            } else {
                currentValue = data.values && data.values.length > 0 ? data.values[data.values.length - 1] : 0;
                console.warn(`é¢„æµ‹æ•°æ®ä¸è¶³24å°æ—¶ï¼Œä½¿ç”¨æœ€åä¸€ä¸ªå€¼: ${currentValue}`);
            }

            // è¿”å›å¤„ç†åçš„æ•°æ®
            return {
                city: city,
                updateTime: data.updateTime,
                currentValue: currentValue,
                avgValue: data.avgValue,
                times: data.times,
                values: data.values,
                low: data.low,
                high: data.high,
                airQuality: getAirQualityInfo(currentValue)
            };
       } catch (error) {
        console.error('æ•°æ®è·å–å¤±è´¥:', error);
        throw error;
    }
}

    // è·å–æ˜¨å¤©çš„å†å²è§‚æµ‹æ•°æ®å’Œé¢„æµ‹æ•°æ®
    async function fetchAccuracyData(city) {
        try {
            // è·å–åŸå¸‚IDæ˜ å°„
            const citiesResponse = await fetch('/api/cities');
            const cities = await citiesResponse.json();

            const cityInfo = cities.find(item => {
                if (item.name === city) return true;
                if (city.endsWith('å¸‚') && item.name === city.slice(0, -1)) return true;
                if (city.endsWith('ç‰¹åˆ«è¡Œæ”¿åŒº') && item.name === city.slice(0, -5)) return true;
                if (item.name.endsWith('å¸‚') && item.name.slice(0, -1) === city) return true;
                return item.name.endsWith('ç‰¹åˆ«è¡Œæ”¿åŒº') && item.name.slice(0, -5) === city;
            });

            if (!cityInfo) {
                throw new Error(`æœªæ‰¾åˆ°åŸå¸‚${city}çš„ID`);
            }

            // å¹¶è¡Œè·å–æ˜¨å¤©çš„å†å²è§‚æµ‹æ•°æ®å’Œé¢„æµ‹æ•°æ®
            const [actualResponse, predictedResponse] = await Promise.all([
                fetch(`/api/no2/${cityInfo.id}`),
                fetch(`/api/historical-predictions/${cityInfo.id}`)
            ]);

            // æ£€æŸ¥å“åº”çŠ¶æ€å¹¶æä¾›å…·ä½“é”™è¯¯ä¿¡æ¯
            let errorMessages = [];
            if (!actualResponse.ok) {
                const actualError = await actualResponse.json();
                errorMessages.push(`å†å²è§‚æµ‹æ•°æ®: ${actualError.error || 'è·å–å¤±è´¥'}`);
            }
            if (!predictedResponse.ok) {
                const predictedError = await predictedResponse.json();
                errorMessages.push(`å†å²é¢„æµ‹æ•°æ®: ${predictedError.error || 'è·å–å¤±è´¥'}`);
            }

            if (errorMessages.length > 0) {
                throw new Error(errorMessages.join('; '));
            }

            const actualData = await actualResponse.json();
            const predictedData = await predictedResponse.json();

            return {
                actual: actualData,
                predicted: predictedData,
                city: city
            };

        } catch (error) {
            console.error('å‡†ç¡®æ€§æ•°æ®è·å–å¤±è´¥:', error);
            throw error;
        }
    }

    // è·å–è¶‹åŠ¿æ•°æ®
    async function fetchTrendData(city) {
        try {
            // è·å–åŸå¸‚IDæ˜ å°„
            const citiesResponse = await fetch('/api/cities');
            const cities = await citiesResponse.json();

            const cityInfo = cities.find(item => {
                if (item.name === city) return true;
                if (city.endsWith('å¸‚') && item.name === city.slice(0, -1)) return true;
                if (city.endsWith('ç‰¹åˆ«è¡Œæ”¿åŒº') && item.name === city.slice(0, -5)) return true;
                if (item.name.endsWith('å¸‚') && item.name.slice(0, -1) === city) return true;
                return item.name.endsWith('ç‰¹åˆ«è¡Œæ”¿åŒº') && item.name.slice(0, -5) === city;
            });

            if (!cityInfo) {
                throw new Error(`æœªæ‰¾åˆ°åŸå¸‚${city}çš„ID`);
            }

            // è·å–è¶‹åŠ¿æ•°æ®
            const response = await fetch(`/api/trend/no2/${cityInfo.id}`);
            if (!response.ok) {
                throw new Error('è¶‹åŠ¿æ•°æ®è·å–å¤±è´¥');
            }
            return await response.json();
        } catch (error) {
            console.error('è¶‹åŠ¿æ•°æ®è·å–å¤±è´¥:', error);
            throw error;
        }
    }

    // è®¡ç®—å‡†ç¡®æ€§æŒ‡æ ‡
    function calculateAccuracyMetrics(actualData, predictedData) {
        const actualValues = actualData.data.map(record => record.no2_concentration);
        const predictedValues = predictedData.values;
        const predictedLow = predictedData.low;
        const predictedHigh = predictedData.high;

        // ç¡®ä¿æ•°æ®é•¿åº¦åŒ¹é…ï¼ˆå–æœ€å°é•¿åº¦ï¼‰
        const minLength = Math.min(actualValues.length, predictedValues.length);
        const actualTrimmed = actualValues.slice(0, minLength);
        const predictedTrimmed = predictedValues.slice(0, minLength);
        const lowTrimmed = predictedLow.slice(0, minLength);
        const highTrimmed = predictedHigh.slice(0, minLength);

        // è®¡ç®—å¹³å‡ç»å¯¹è¯¯å·® (MAE)
        const mae = actualTrimmed.reduce((sum, actual, i) => {
            return sum + Math.abs(actual - predictedTrimmed[i]);
        }, 0) / actualTrimmed.length;

        // è®¡ç®—é¢„æµ‹åŒºé—´è¦†ç›–ç‡
        let covered = 0;
        actualTrimmed.forEach((actual, i) => {
            if (actual >= lowTrimmed[i] && actual <= highTrimmed[i]) {
                covered++;
            }
        });
        const coverage = (covered / actualTrimmed.length) * 100;

        return {
            mae: mae.toFixed(2),
            coverage: coverage.toFixed(1),
            dataPoints: minLength
        };
    }

    // æ¸²æŸ“å‡†ç¡®æ€§å¯¹æ¯”å›¾è¡¨
    function renderAccuracyChart(accuracyData) {
        const ctx = document.getElementById('accuracyChartCanvas').getContext('2d');

        if (accuracyChartInstance) {
            accuracyChartInstance.destroy();
        }

        const actualData = accuracyData.actual.data;
        const predictedData = accuracyData.predicted;

        // å‡†å¤‡æ•°æ®ï¼ˆç¡®ä¿æ—¶é—´å¯¹é½ï¼‰
        const times = predictedData.times;
        const actualValues = actualData.map(record => record.no2_concentration);
        const predictedValues = predictedData.values;
        const predictedLow = predictedData.low;
        const predictedHigh = predictedData.high;

        // è®¡ç®—å‡†ç¡®æ€§æŒ‡æ ‡
        const metrics = calculateAccuracyMetrics(accuracyData.actual, predictedData);

        // æ›´æ–°å‡†ç¡®æ€§æŒ‡æ ‡æ˜¾ç¤º
        document.getElementById('maeValue').textContent = `${metrics.mae} Î¼g/mÂ³`;
        document.getElementById('coverageValue').textContent = `${metrics.coverage}%`;
        document.getElementById('accuracyUpdateTime').textContent = accuracyData.actual.date;

        accuracyChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: times,
                datasets: [
                    {
                        label: 'å®é™…è§‚æµ‹å€¼',
                        data: actualValues,
                        borderWidth: 4,
                        borderColor: 'rgba(220, 38, 127, 1)',
                        backgroundColor: 'rgba(220, 38, 127, 0.1)',
                        fill: false,
                        tension: 0.1,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: 'rgba(220, 38, 127, 1)',
                        pointBorderColor: 'white',
                        pointBorderWidth: 2,
                        order: 1
                    },
                    {
                        label: 'é¢„æµ‹å€¼',
                        data: predictedValues,
                        borderWidth: 3,
                        borderColor: 'rgba(59, 130, 246, 0.8)',
                        backgroundColor: 'transparent',
                        fill: false,
                        borderDash: [8, 4],
                        tension: 0.1,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: 'rgba(59, 130, 246, 0.8)',
                        pointBorderColor: 'white',
                        pointBorderWidth: 1,
                        order: 2
                    },
                    {
                        label: 'é¢„æµ‹åŒºé—´ä¸‹é™',
                        data: predictedLow,
                        borderWidth: 2,
                        borderColor: 'rgba(156, 163, 175, 0.6)',
                        backgroundColor: 'rgba(229, 231, 235, 0.3)',
                        fill: '+1',
                        borderDash: [4, 4],
                        tension: 0.2,
                        pointRadius: 0,
                        order: 3
                    },
                    {
                        label: 'é¢„æµ‹åŒºé—´ä¸Šé™',
                        data: predictedHigh,
                        borderWidth: 2,
                        borderColor: 'rgba(156, 163, 175, 0.6)',
                        backgroundColor: 'transparent',
                        borderDash: [4, 4],
                        tension: 0.2,
                        pointRadius: 0,
                        order: 4
                    }
                ]
            },
            options: {
                responsive: true,
                devicePixelRatio: 2,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'NOâ‚‚æµ“åº¦ï¼ˆÎ¼g/mÂ³ï¼‰',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: '#333'
                        },
                        ticks: {
                            font: { size: 13 },
                            weight: 'bold',
                            color: '#222'
                        },
                        grid: {
                            color: 'rgba(200, 200, 200, 0.6)',
                            lineWidth: 1
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'æ—¶é—´ (æ˜¨å¤©)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: '#222'
                        },
                        ticks: {
                            maxTicksLimit: 12,
                            font: {
                                size: 13,
                                weight: '600'
                            },
                            color: '#222',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 12, weight: '500' },
                            color: '#374151',
                            usePointStyle: false,
                            generateLabels: function(chart) {
                                const datasets = chart.data.datasets;
                                return datasets.map((dataset, i) => {
                                    return {
                                        text: dataset.label,
                                        fillStyle: dataset.backgroundColor,
                                        strokeStyle: dataset.borderColor,
                                        lineWidth: Math.max(2, dataset.borderWidth || 2),
                                        lineDash: dataset.borderDash || [],
                                        hidden: !chart.isDatasetVisible(i),
                                        datasetIndex: i
                                    };
                                });
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#1f2937',
                        bodyColor: '#4b5563',
                        borderColor: '#d1d5db',
                        borderWidth: 1,
                        padding: 12,
                        bodyFont: { size: 12 },
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y.toFixed(1);
                                return `${label}: ${value} Î¼g/mÂ³`;
                            }
                        }
                    }
                }
            }
        });
    }

    // æ¸²æŸ“å›¾è¡¨
    function renderChart(data) {
        const ctx = document.getElementById('chartCanvas').getContext('2d');

        if (chartInstance) {
            chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.times,
                datasets: [
                    {
                        label: 'NOâ‚‚æµ“åº¦ (Î¼g/mÂ³)',
                        data: data.values,
                        borderWidth: 3,
                        borderColor: 'rgba(33, 150, 243, 1)',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        fill: false,
                        tension: 0.1,
                        pointRadius: 6,
                        pointHoverRadius: 7,
                        pointBackgroundColor: 'white',
                        pointBorderColor: 'rgba(33, 150, 243, 1)',
                        pointBorderWidth: 2
                    },
                    {
                        label: 'é¢„æµ‹åŒºé—´ä¸‹é™',
                        data: data.low,
                        borderWidth: 4,
                        borderColor: 'rgba(255, 152, 0, 0.7)',
                        backgroundColor: 'rgba(255, 152, 0, 0.45)',
                        fill: true,
                        borderDash: [5, 5],
                        tension: 0.3,
                        pointRadius: 0,
                        order: 1
                    },
                    {
                        label: 'é¢„æµ‹åŒºé—´ä¸Šé™',
                        data: data.high,
                        borderWidth: 4,
                        borderColor: 'rgba(255, 152, 0, 0.8)',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        tension: 0.1,
                        pointRadius: 0,
                        order: 2
                    }
                ]
            },
            options: {
                responsive: true,
                devicePixelRatio: 2,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'NOâ‚‚æµ“åº¦ï¼ˆÎ¼g/mÂ³ï¼‰',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: '#333'
                        },
                        ticks: {
                            font: { size: 13 },
                            weight: 'bold',
                            color: '#222'
                        },
                        grid: {
                            color: 'rgba(200, 200, 200, 0.6)',
                            lineWidth: 1
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'æ—¶é—´',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: '#222'
                        },
                        ticks: {
                            maxTicksLimit: 12,
                            font: {
                                size: 13,
                                weight: '600'
                            },
                            color: '#222',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 13, weight: '500' },
                            color: '#222'
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#333',
                        bodyColor: '#666',
                        borderColor: '#ddd',
                        borderWidth: 1,
                        padding: 10,
                        bodyFont: { size: 13 }
                    }
                }
            }
        });
    }

    // æ¸²æŸ“è¶‹åŠ¿å›¾è¡¨
    function renderTrendChart(trendData) {
        const ctx = document.getElementById('trendChartCanvas').getContext('2d');

        // å¦‚æœå·²æœ‰å›¾è¡¨å®ä¾‹ï¼Œå…ˆé”€æ¯
        if (trendChartInstance) {
            trendChartInstance.destroy();
        }

        // å‡†å¤‡å›¾è¡¨æ•°æ®
        const labels = trendData.data.map(item => item.date.substring(5)); // åªæ˜¾ç¤ºæœˆ-æ—¥
        const values = trendData.data.map(item => item.avg_no2);

        trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'NOâ‚‚æ—¥å‡æµ“åº¦ (Î¼g/mÂ³)',
                    data: values,
                    borderColor: 'rgba(59, 130, 246, 0.9)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    pointBackgroundColor: 'white',
                    pointBorderColor: 'rgba(59, 130, 246, 1)',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    tension: 0.2,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'NOâ‚‚æµ“åº¦ï¼ˆÎ¼g/mÂ³ï¼‰',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: '#222'
                        },
                        ticks: {
                            font: { size: 13 },
                            weight: 'bold',
                            color: '#222'
                        },
                        grid: {
                            color: 'rgba(200, 200, 200, 0.6)',
                            lineWidth: 1
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'æ—¥æœŸ',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: '#222'
                        },
                        ticks: {
                            maxTicksLimit: 15,
                            font: {
                                size: 13,
                                weight: '600'
                            },
                            color: '#222'
                        },
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 13, weight: '500' },
                            color: '#222'
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#333',
                        bodyColor: '#666',
                        borderColor: '#ddd',
                        borderWidth: 1,
                        padding: 10,
                        bodyFont: { size: 13 },
                        callbacks: {
                            title: (items) => {
                                const index = items[0].dataIndex;
                                return trendData.data[index].date; // å®Œæ•´æ—¥æœŸ
                            },
                            label: (context) => {
                                return `æµ“åº¦: ${context.parsed.y.toFixed(1)} Î¼g/mÂ³`;
                            }
                        }
                    }
                }
            }
        });
    }

    // å¤„ç†è¶‹åŠ¿æ•°æ®
    function processTrendData(trendData) {
        // æ›´æ–°ç»Ÿè®¡æ•°æ®å¡ç‰‡
        const statsContainer = document.querySelector('.trend-stats');
        if (statsContainer) {
            const statCards = statsContainer.querySelectorAll('.trend-stat-card');

            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const values = trendData.data.map(item => item.avg_no2);
            const avgValue = values.reduce((sum, val) => sum + val, 0) / values.length;
            const maxValue = Math.max(...values);
            const minValue = Math.min(...values);
            const changeRange = maxValue - minValue;

            // æ›´æ–°å¡ç‰‡å†…å®¹
            statCards[0].querySelector('.stat-value').textContent = avgValue.toFixed(1);
            statCards[1].querySelector('.stat-value').textContent = maxValue.toFixed(1);
            statCards[2].querySelector('.stat-value').textContent = minValue.toFixed(1);
            statCards[3].querySelector('.stat-value').textContent = changeRange.toFixed(1);
        }

        // æ›´æ–°è¶‹åŠ¿åˆ†ææŠ¥å‘Š
        const analysisContainer = document.querySelector('.analysis-list');
        if (analysisContainer) {
            analysisContainer.innerHTML = '';

            // åˆ›å»ºåˆ†ææŠ¥å‘Šé¡¹ç›®
            const analysisItems = [
                `æ•´ä½“è¶‹åŠ¿ï¼š${getTrendDescription(trendData.data)}`,
                `æœ€é«˜å€¼å‡ºç°åœ¨ ${getMaxDate(trendData.data)}ï¼Œæœ€ä½å€¼å‡ºç°åœ¨ ${getMinDate(trendData.data)}`,
                `å¹³å‡æµ“åº¦ï¼š${(trendData.data.reduce((sum, item) => sum + item.avg_no2, 0) / trendData.data.length).toFixed(1)} Î¼g/mÂ³`,
                `æ³¢åŠ¨èŒƒå›´ï¼š${(Math.max(...trendData.data.map(item => item.avg_no2)) - Math.min(...trendData.data.map(item => item.avg_no2))).toFixed(1)} Î¼g/mÂ³`
            ];

            // æ·»åŠ åˆ°åˆ—è¡¨
            analysisItems.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                analysisContainer.appendChild(li);
            });
        }

        // æ¸²æŸ“è¶‹åŠ¿å›¾è¡¨
        renderTrendChart(trendData);
    }

    // è¾…åŠ©å‡½æ•°ï¼šè·å–è¶‹åŠ¿æè¿°
    function getTrendDescription(data) {
        if (data.length < 2) return 'æ•°æ®ä¸è¶³æ— æ³•åˆ†æ';

        const first = data[0].avg_no2;
        const last = data[data.length - 1].avg_no2;
        const diff = last - first;

        if (diff > 5) return 'å‘ˆæ˜æ˜¾ä¸Šå‡è¶‹åŠ¿';
        if (diff < -5) return 'å‘ˆæ˜æ˜¾ä¸‹é™è¶‹åŠ¿';
        if (Math.abs(diff) <= 5) return 'ä¿æŒç›¸å¯¹ç¨³å®š';
        return 'æ³¢åŠ¨è¾ƒå°';
    }

    // è¾…åŠ©å‡½æ•°ï¼šè·å–æœ€é«˜æµ“åº¦æ—¥æœŸ
    function getMaxDate(data) {
        const maxItem = data.reduce((max, item) =>
            item.avg_no2 > max.avg_no2 ? item : max, data[0]);
        return maxItem.date.substring(5); // åªæ˜¾ç¤ºæœˆ-æ—¥
    }

    // è¾…åŠ©å‡½æ•°ï¼šè·å–æœ€ä½æµ“åº¦æ—¥æœŸ
    function getMinDate(data) {
        const minItem = data.reduce((min, item) =>
            item.avg_no2 < min.avg_no2 ? item : min, data[0]);
        return minItem.date.substring(5); // åªæ˜¾ç¤ºæœˆ-æ—¥
    }

    // æ¸²æŸ“åˆ†ç±»å»ºè®®
    function renderRecommendations(recommendations) {
        // å®šä¹‰åˆ†ç±»å’Œå¯¹åº”DOMå…ƒç´ çš„æ˜ å°„
        const categories = [
            { id: 'travelRecommendations', items: recommendations.travel },
            { id: 'homeRecommendations', items: recommendations.home },
            { id: 'outdoorRecommendations', items: recommendations.outdoor },
            { id: 'exerciseRecommendations', items: recommendations.exercise },
            { id: 'specialRecommendations', items: recommendations.special },
            { id: 'generalRecommendations', items: recommendations.general }
        ];

        // ä¸ºæ¯ä¸ªåˆ†ç±»æ¸²æŸ“å»ºè®®å†…å®¹
        categories.forEach(category => {
            const listElement = document.getElementById(category.id);
            listElement.innerHTML = '';

            category.items.forEach(itemText => {
                const li = document.createElement('li');
                li.className = 'recommendation-item';
                li.textContent = itemText;
                listElement.appendChild(li);
            });
        });
    }

    // åˆå§‹åŒ–æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
    function initTabs() {
        // å¤„ç†é¢„æµ‹ç»“æœæ ‡ç­¾
        const predictionTabs = document.querySelectorAll('.prediction-tabs .tab-card');
        predictionTabs.forEach(card => {
            card.addEventListener('click', () => {
                const tabName = card.getAttribute('data-tab');

                // ç§»é™¤é¢„æµ‹ç»“æœåŒºåŸŸçš„æ¿€æ´»çŠ¶æ€
                document.querySelectorAll('.prediction-tabs .tab-card').forEach(c => {
                    c.classList.remove('active');
                });
                document.querySelectorAll('.prediction-section .content-panel').forEach(p => {
                    p.classList.remove('active');
                });

                // æ·»åŠ å½“å‰æ¿€æ´»çŠ¶æ€
                card.classList.add('active');
                document.getElementById(`${tabName}-panel`).classList.add('active');
            });
        });

        // å¤„ç†é˜²æŠ¤å»ºè®®æ ‡ç­¾
        const recommendationTabs = document.querySelectorAll('.recommendation-tabs .tab-card');
        recommendationTabs.forEach(card => {
            card.addEventListener('click', () => {
                const tabName = card.getAttribute('data-tab');

                // ç§»é™¤é˜²æŠ¤å»ºè®®åŒºåŸŸçš„æ¿€æ´»çŠ¶æ€
                document.querySelectorAll('.recommendation-tabs .tab-card').forEach(c => {
                    c.classList.remove('active');
                });
                document.querySelectorAll('.recommendations-section .content-panel').forEach(p => {
                    p.classList.remove('active');
                });

                // æ·»åŠ å½“å‰æ¿€æ´»çŠ¶æ€
                card.classList.add('active');
                document.getElementById(`${tabName}-panel`).classList.add('active');
            });
        });

        // å¤„ç†è¶‹åŠ¿åˆ†ææ ‡ç­¾
        const trendTabs = document.querySelectorAll('.trend-tabs .tab-card');
        trendTabs.forEach(card => {
            card.addEventListener('click', () => {
                const tabName = card.getAttribute('data-tab');

                // ç§»é™¤è¶‹åŠ¿åˆ†æåŒºåŸŸçš„æ¿€æ´»çŠ¶æ€
                document.querySelectorAll('.trend-tabs .tab-card').forEach(c => {
                    c.classList.remove('active');
                });
                document.querySelectorAll('.trend-section .content-panel').forEach(p => {
                    p.classList.remove('active');
                });

                // æ·»åŠ å½“å‰æ¿€æ´»çŠ¶æ€
                card.classList.add('active');
                document.getElementById(`${tabName}-panel`).classList.add('active');
            });
        });

        // å¤„ç†å‡†ç¡®æ€§åˆ†ææ ‡ç­¾
        const accuracyTabs = document.querySelectorAll('.accuracy-tabs .tab-card');
        accuracyTabs.forEach(card => {
            card.addEventListener('click', () => {
                const tabName = card.getAttribute('data-tab');

                // ç§»é™¤å‡†ç¡®æ€§åˆ†æåŒºåŸŸçš„æ¿€æ´»çŠ¶æ€
                document.querySelectorAll('.accuracy-tabs .tab-card').forEach(c => {
                    c.classList.remove('active');
                });
                document.querySelectorAll('.accuracy-section .content-panel').forEach(p => {
                    p.classList.remove('active');
                });

                // æ·»åŠ å½“å‰æ¿€æ´»çŠ¶æ€
                card.classList.add('active');
                document.getElementById(`${tabName}-panel`).classList.add('active');
            });
        });
    }

    // å¯¼èˆªæ æ¿€æ´»çŠ¶æ€ç®¡ç†
    function initNavigation() {
        const navItems = document.querySelectorAll('.section-nav .nav-item');
        const sections = document.querySelectorAll('[id$="-section"]');

        // æ»šåŠ¨æ—¶æ›´æ–°å¯¼èˆªçŠ¶æ€
        function updateActiveNav() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

            sections.forEach((section, index) => {
                const rect = section.getBoundingClientRect();
                const isInView = rect.top <= 100 && rect.bottom >= 100;

                if (isInView) {
                    navItems.forEach(item => item.classList.remove('active'));
                    navItems[index]?.classList.add('active');
                }
            });
        }

        // ç›‘å¬æ»šåŠ¨äº‹ä»¶
        window.addEventListener('scroll', updateActiveNav);

        // åˆå§‹åŒ–æ—¶è®¾ç½®ç¬¬ä¸€ä¸ªä¸ºæ¿€æ´»çŠ¶æ€
        navItems[0]?.classList.add('active');
    }

    // è®¾ç½®æ ‡é¢˜ä¸‹åˆ’çº¿å®½åº¦ä¸æ–‡å­—ç­‰é•¿
    function setTitleUnderlines() {
        const titles = document.querySelectorAll('.prediction-section h2, .recommendations-section h2, .trend-section h2, .accuracy-section h2');

        titles.forEach(title => {
            // åˆ›å»ºä¸´æ—¶å…ƒç´ æ¥æµ‹é‡æ–‡å­—å®½åº¦
            const tempSpan = document.createElement('span');
            tempSpan.style.visibility = 'hidden';
            tempSpan.style.position = 'absolute';
            tempSpan.style.fontSize = getComputedStyle(title).fontSize;
            tempSpan.style.fontWeight = getComputedStyle(title).fontWeight;
            tempSpan.style.fontFamily = getComputedStyle(title).fontFamily;
            tempSpan.textContent = title.textContent;

            document.body.appendChild(tempSpan);
            const textWidth = tempSpan.offsetWidth;
            document.body.removeChild(tempSpan);

            // è®¾ç½®ä¼ªå…ƒç´ å®½åº¦
            title.style.setProperty('--underline-width', textWidth + 'px');
        });
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    window.addEventListener('load', async () => {
        const city = getUrlParameter('city') || 'å¹¿å·';

        // è®¾ç½®åŸå¸‚èƒŒæ™¯å›¾ç‰‡
        document.body.style.backgroundImage = `url('${getCityBackgroundImage(city)}')`;

        // åˆå§‹åŒ–æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½å’Œå¯¼èˆªæ 
        initTabs();
        initNavigation();

        // è®¾ç½®æ ‡é¢˜ä¸‹åˆ’çº¿å®½åº¦
        setTitleUnderlines();

        // ä»åç«¯APIè°ƒå–æ•°æ®
        try {
            const realData = await fetchCityData(city);

            // æ›´æ–°é¡µé¢å†…å®¹
            document.getElementById('cityName').textContent = `${realData.city} NOâ‚‚ æµ“åº¦è¯¦æƒ…`;
            document.getElementById('updateTime').textContent = `æ›´æ–°æ—¶é—´ï¼š${realData.updateTime}`;
            document.getElementById('currentValue').textContent = realData.currentValue;
            document.getElementById('avgValue').textContent = realData.avgValue;
            document.getElementById('qualityLevel').textContent = realData.airQuality.level;
            document.getElementById('qualityLevel').style.color = realData.airQuality.color;

            // æ¸²æŸ“åˆ†ç±»å»ºè®®
            renderRecommendations(realData.airQuality.recommendations);

            // æ¸²æŸ“å›¾è¡¨
            renderChart(realData);

            // è·å–å¹¶å¤„ç†è¶‹åŠ¿æ•°æ®
            try {
                const trendData = await fetchTrendData(city);
                processTrendData(trendData);
            } catch (trendError) {
                console.error('è¶‹åŠ¿æ•°æ®åŠ è½½å¤±è´¥:', trendError);
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯æˆ–å ä½ç¬¦
                document.querySelectorAll('.trend-stat-card .stat-value').forEach(el => {
                    el.textContent = '--';
                });
                document.querySelector('.analysis-list').innerHTML = `
                    <li>è¶‹åŠ¿åˆ†æåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨</li>
                    <li>é”™è¯¯åŸå› : ${trendError.message}</li>
                `;
            }

            // åŠ è½½å¹¶æ¸²æŸ“é¢„æµ‹å‡†ç¡®æ€§åˆ†æ
            try {
                const accuracyData = await fetchAccuracyData(city);
                renderAccuracyChart(accuracyData);
            } catch (accuracyError) {
                console.error('å‡†ç¡®æ€§åˆ†ææ•°æ®åŠ è½½å¤±è´¥:', accuracyError);
                document.getElementById('maeValue').textContent = 'æš‚æ— æ•°æ®';
                document.getElementById('coverageValue').textContent = 'æš‚æ— æ•°æ®';
                document.getElementById('accuracyUpdateTime').textContent = 'æ•°æ®è·å–å¤±è´¥';

                const accuracyCanvas = document.getElementById('accuracyChartCanvas');
                const ctx = accuracyCanvas.getContext('2d');
                ctx.fillStyle = '#f3f4f6';
                ctx.fillRect(0, 0, accuracyCanvas.width, accuracyCanvas.height);
                ctx.fillStyle = '#6b7280';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ˜¨å¤©çš„å¯¹æ¯”æ•°æ®', accuracyCanvas.width / 2, accuracyCanvas.height / 2);
                ctx.fillText('(éœ€è¦å†å²é¢„æµ‹æ•°æ®å’Œè§‚æµ‹æ•°æ®)', accuracyCanvas.width / 2, accuracyCanvas.height / 2 + 25);
            }

        } catch (error) {
            console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
            alert('æ— æ³•è·å–åŸå¸‚æ•°æ®ï¼Œè¯·ç¨åé‡è¯•');
        }
    });

    // AIå°åŠ©æ‰‹åŠŸèƒ½
    let currentCityData = null; // ä¿å­˜å½“å‰åŸå¸‚æ•°æ®ç”¨äºAIå›ç­”

    // åˆå§‹åŒ–AIå°åŠ©æ‰‹
    function initAIAssistant() {
        const aiButton = document.getElementById('aiAssistant');
        const chatWindow = document.getElementById('aiChatWindow');
        const closeButton = document.getElementById('aiChatClose');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('chatSendBtn');
        const presetButtons = document.querySelectorAll('.preset-question-btn');
        
        // è®¾ç½®æ¬¢è¿æ¶ˆæ¯æ—¶é—´
        const welcomeTimeElement = document.getElementById('welcomeTime');
        welcomeTimeElement.textContent = new Date().toLocaleTimeString();

        // æ‰“å¼€/å…³é—­èŠå¤©çª—å£
        aiButton.addEventListener('click', () => {
            chatWindow.style.display = chatWindow.style.display === 'flex' ? 'none' : 'flex';
        });

        closeButton.addEventListener('click', () => {
            chatWindow.style.display = 'none';
        });

        // é¢„è®¾é—®é¢˜ç‚¹å‡»äº‹ä»¶
        presetButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const question = btn.getAttribute('data-question');
                sendMessage(question);
            });
        });

        // å‘é€æ¶ˆæ¯
        sendButton.addEventListener('click', () => {
            const message = chatInput.value.trim();
            if (message) {
                sendMessage(message);
                chatInput.value = '';
            }
        });

        // å›è½¦å‘é€
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const message = chatInput.value.trim();
                if (message) {
                    sendMessage(message);
                    chatInput.value = '';
                }
            }
        });
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage(message) {
        const messagesContainer = document.getElementById('aiChatMessages');
        const typingIndicator = document.getElementById('typingIndicator');
        const sendButton = document.getElementById('chatSendBtn');
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        addMessage(message, 'user');
        
        // ç¦ç”¨å‘é€æŒ‰é’®å¹¶æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
        sendButton.disabled = true;
        typingIndicator.style.display = 'block';
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        try {
            // å‡†å¤‡ä¸Šä¸‹æ–‡æ•°æ®
            const contextData = {
                city: getUrlParameter('city') || 'å¹¿å·',
                currentValue: currentCityData?.currentValue || null,
                avgValue: currentCityData?.avgValue || null,
                qualityLevel: currentCityData?.airQuality?.level || null
            };

            // å‘é€åˆ°åç«¯AI API
            const response = await fetch('/api/ai-assistant', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    context: contextData
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            
            // æ·»åŠ AIå›å¤
            addMessage(data.response, 'ai');
            
        } catch (error) {
            console.error('AIè¯·æ±‚å¤±è´¥:', error);
            // æ·»åŠ é”™è¯¯æ¶ˆæ¯
            addMessage('æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ã€‚è¯·ç¨åå†è¯•æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚', 'ai');
        } finally {
            // æ¢å¤å‘é€æŒ‰é’®å¹¶éšè—æ‰“å­—æŒ‡ç¤ºå™¨
            sendButton.disabled = false;
            typingIndicator.style.display = 'none';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
    function addMessage(text, type) {
        const messagesContainer = document.getElementById('aiChatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${type}`;
        
        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = `message-bubble ${type}`;
        bubbleDiv.textContent = text;
        
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = new Date().toLocaleTimeString();
        
        messageDiv.appendChild(bubbleDiv);
        messageDiv.appendChild(timeDiv);
        messagesContainer.appendChild(messageDiv);
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // ä¿®æ”¹åŸæœ‰çš„é¡µé¢åŠ è½½é€»è¾‘ï¼Œä¿å­˜åŸå¸‚æ•°æ®
    window.addEventListener('load', async () => {
        const city = getUrlParameter('city') || 'å¹¿å·';

        // è®¾ç½®åŸå¸‚èƒŒæ™¯å›¾ç‰‡
        document.body.style.backgroundImage = `url('${getCityBackgroundImage(city)}')`;

        // åˆå§‹åŒ–æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½å’Œå¯¼èˆªæ 
        initTabs();
        initNavigation();
        
        // è®¾ç½®æ ‡é¢˜ä¸‹åˆ’çº¿å®½åº¦
        setTitleUnderlines();

        // åˆå§‹åŒ–AIå°åŠ©æ‰‹
        initAIAssistant();

        // ä»åç«¯APIè°ƒå–æ•°æ®
        try {
            const realData = await fetchCityData(city);
            
            // ä¿å­˜æ•°æ®ä¾›AIä½¿ç”¨
            currentCityData = realData;
            
            // æ›´æ–°é¡µé¢å†…å®¹
            document.getElementById('cityName').textContent = `${realData.city} NOâ‚‚ æµ“åº¦è¯¦æƒ…`;
            document.getElementById('updateTime').textContent = `æ›´æ–°æ—¶é—´ï¼š${realData.updateTime}`;
            document.getElementById('currentValue').textContent = realData.currentValue;
            document.getElementById('avgValue').textContent = realData.avgValue;
            document.getElementById('qualityLevel').textContent = realData.airQuality.level;
            document.getElementById('qualityLevel').style.color = realData.airQuality.color;

            // æ¸²æŸ“åˆ†ç±»å»ºè®®
            renderRecommendations(realData.airQuality.recommendations);

            // æ¸²æŸ“å›¾è¡¨
            renderChart(realData);
            
            // åŠ è½½å¹¶æ¸²æŸ“é¢„æµ‹å‡†ç¡®æ€§åˆ†æ
            try {
                const accuracyData = await fetchAccuracyData(city);
                renderAccuracyChart(accuracyData);
            } catch (accuracyError) {
                console.error('å‡†ç¡®æ€§åˆ†ææ•°æ®åŠ è½½å¤±è´¥:', accuracyError);
                document.getElementById('maeValue').textContent = 'æš‚æ— æ•°æ®';
                document.getElementById('coverageValue').textContent = 'æš‚æ— æ•°æ®';
                document.getElementById('accuracyUpdateTime').textContent = 'æ•°æ®è·å–å¤±è´¥';
                
                const accuracyCanvas = document.getElementById('accuracyChartCanvas');
                const ctx = accuracyCanvas.getContext('2d');
                ctx.fillStyle = '#f3f4f6';
                ctx.fillRect(0, 0, accuracyCanvas.width, accuracyCanvas.height);
                ctx.fillStyle = '#6b7280';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ˜¨å¤©çš„å¯¹æ¯”æ•°æ®', accuracyCanvas.width / 2, accuracyCanvas.height / 2);
                ctx.fillText('(éœ€è¦å†å²é¢„æµ‹æ•°æ®å’Œè§‚æµ‹æ•°æ®)', accuracyCanvas.width / 2, accuracyCanvas.height / 2 + 25);
            }
            
        } catch (error) {
            console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
            alert('æ— æ³•è·å–åŸå¸‚æ•°æ®ï¼Œè¯·ç¨åé‡è¯•');
        }
    });
</script>
</body>
</html>